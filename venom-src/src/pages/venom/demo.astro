---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Card from '../../components/Card.astro';

const title = 'VENOM Demo - Interactive AI Crawler Preview';
const description = 'See how VENOM transforms content for AI crawlers while preserving the human experience.';
---

<BaseLayout title={title} description={description} currentPath="/venom/demo/">
  <section class="demo-section">
    <div class="container">
      <!-- Title -->
      <div class="demo-header">
        <h1>Interactive Demo</h1>
        <p class="demo-subtitle">Enter any URL to compare the original vs. AI crawler view</p>
      </div>

      <!-- Controls -->
      <Card class="controls-card">
        <div class="controls-grid">
          <!-- URL Input -->
          <div class="control-group control-url">
            <label for="url-input">Website URL</label>
            <input
              type="url"
              id="url-input"
              placeholder="https://semiautonomous.systems"
              value="https://semiautonomous.systems"
              class="input"
            />
          </div>

          <!-- Options Row -->
          <div class="control-group">
            <label for="bot-select">Bot Type</label>
            <select id="bot-select" class="select">
              <option value="gptbot">GPTBot (OpenAI)</option>
              <option value="claude">Claude (Anthropic)</option>
              <option value="google">Google AI</option>
              <option value="bingbot">Bing AI</option>
              <option value="meta">Meta AI</option>
            </select>
          </div>

          <div class="control-group">
            <label for="device-select">Device</label>
            <select id="device-select" class="select">
              <option value="desktop">Desktop (1280×720)</option>
              <option value="mobile">Mobile (390×844)</option>
            </select>
          </div>

          <div class="control-group control-checkbox">
            <label class="checkbox-label">
              <input type="checkbox" id="inline-mode" checked class="checkbox" />
              <span>Inline Mode</span>
            </label>
          </div>

          <!-- Load Button -->
          <div class="control-group control-button">
            <button id="load-btn" class="btn btn-primary">
              Load Preview
            </button>
          </div>
        </div>
      </Card>

      <!-- Screenshot Panels -->
      <div class="panels-container" id="panels-container">
        <!-- Original -->
        <Card class="panel-card">
          <h3 class="panel-title">
            <span class="status-dot status-safe"></span>
            Original (Human View)
          </h3>
          <div id="original-panel" class="panel-preview">
            Click "Load Preview" to generate
          </div>
          <div id="original-stats" class="panel-stats"></div>
        </Card>

        <!-- Poisoned -->
        <Card class="panel-card">
          <h3 class="panel-title">
            <span class="status-dot status-danger"></span>
            Venom Preview (AI Crawler View)
          </h3>
          <div id="poisoned-panel" class="panel-preview">
            Click "Load Preview" to generate
          </div>
          <div id="poisoned-stats" class="panel-stats"></div>
        </Card>
      </div>

      <!-- Scroll Indicator (touch devices only) -->
      <div class="scroll-indicator" id="scroll-indicator" aria-hidden="true">
        <button class="scroll-dot active" data-index="0" aria-label="View original"></button>
        <button class="scroll-dot" data-index="1" aria-label="View VENOM preview"></button>
      </div>

      <!-- Quick Examples -->
      <Card class="examples-card">
        <h4 class="examples-title">Quick Examples</h4>
        <div class="examples-grid">
          <button data-url="https://semiautonomous.systems" class="example-btn">Semiautonomous</button>
          <button data-url="https://www.bbc.com" class="example-btn">BBC News</button>
          <button data-url="https://arxiv.org" class="example-btn">arXiv</button>
          <button data-url="https://developer.mozilla.org" class="example-btn">MDN</button>
          <button data-url="https://news.ycombinator.com" class="example-btn">Hacker News</button>
          <button data-url="https://www.w3.org" class="example-btn">W3C</button>
        </div>
      </Card>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox">
    <button class="lightbox-close" aria-label="Close">&times;</button>
    <img id="lightbox-img" src="" alt="Enlarged screenshot" />
  </div>
</BaseLayout>

<style>
  .demo-section {
    padding: var(--space-xl) 0 var(--space-3xl);
  }

  .demo-header {
    text-align: center;
    margin-bottom: var(--space-xl);
  }

  .demo-header h1 {
    font-size: clamp(24px, 4vw, 32px);
    margin-bottom: var(--space-sm);
  }

  .demo-subtitle {
    color: var(--color-text-muted);
    font-size: clamp(14px, 2vw, 16px);
  }

  /* Controls Card */
  .controls-card {
    margin-bottom: var(--space-lg);
  }

  .controls-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
  }

  @media (min-width: 640px) {
    .controls-grid {
      grid-template-columns: 1fr 1fr;
    }

    .control-url {
      grid-column: 1 / -1;
    }

    .control-button {
      grid-column: 1 / -1;
    }
  }

  @media (min-width: 900px) {
    .controls-grid {
      grid-template-columns: 1fr 1fr 1fr auto auto;
      align-items: end;
    }

    .control-url {
      grid-column: 1 / -1;
    }

    .control-checkbox {
      justify-self: start;
    }

    .control-button {
      grid-column: auto;
    }
  }

  .control-group label {
    display: block;
    font-size: 14px;
    color: var(--color-text-muted);
    margin-bottom: var(--space-xs);
  }

  .input,
  .select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    background: rgba(15, 20, 27, 0.5);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 14px;
    transition: var(--transition-fast);
  }

  .input:focus,
  .select:focus {
    outline: none;
    border-color: var(--color-text-muted);
  }

  .input::placeholder {
    color: var(--color-text-muted);
    opacity: 0.6;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    padding: var(--space-sm) 0;
  }

  .checkbox {
    width: 16px;
    height: 16px;
    border-radius: var(--radius-sm);
    background: rgba(15, 20, 27, 0.5);
    border: 1px solid var(--color-border);
    cursor: pointer;
  }

  .checkbox-label span {
    font-size: 14px;
    color: var(--color-text-muted);
  }

  /* Panels */
  .panels-container {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-sm);
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    padding-bottom: var(--space-sm);
    margin-left: calc(-1 * var(--container-padding));
    margin-right: calc(-1 * var(--container-padding));
    padding-left: var(--container-padding);
    padding-right: var(--container-padding);
    /* Hide scrollbar but keep functionality */
    scrollbar-width: none;
    -ms-overflow-style: none;
    /* Smooth momentum scrolling on iOS */
    -webkit-overflow-scrolling: touch;
  }

  .panels-container::-webkit-scrollbar {
    display: none;
  }

  @media (min-width: 1024px) {
    .panels-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      overflow: visible;
      margin-left: 0;
      margin-right: 0;
      padding-left: 0;
      padding-right: 0;
      margin-bottom: var(--space-xl);
    }
  }

  .panel-card {
    min-width: 92vw;
    width: 92vw;
    flex-shrink: 0;
    scroll-snap-align: center;
  }

  @media (min-width: 480px) {
    .panel-card {
      min-width: 85vw;
      width: 85vw;
    }
  }

  @media (min-width: 640px) {
    .panel-card {
      min-width: 70vw;
      width: 70vw;
    }
  }

  @media (min-width: 1024px) {
    .panel-card {
      min-width: 0;
      width: auto;
    }
  }

  .panel-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-safe {
    background: var(--color-safe);
  }

  .status-danger {
    background: var(--color-accent);
  }

  .panel-preview {
    aspect-ratio: var(--preview-aspect-ratio, 16 / 9);
    background: rgba(15, 20, 27, 0.5);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    font-size: 14px;
    overflow: hidden;
    transition: aspect-ratio 0.3s ease;
  }

  .panel-preview :global(img) {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .panel-stats {
    font-size: 12px;
    color: var(--color-text-muted);
    margin-top: var(--space-sm);
  }

  /* Scroll Indicator - only visible on touch devices at smaller screens */
  .scroll-indicator {
    display: none;
    justify-content: center;
    gap: 8px;
    margin-bottom: var(--space-lg);
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  .scroll-indicator.hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Show only on touch/coarse pointer devices below desktop breakpoint */
  @media (max-width: 1023px) and (hover: none), (max-width: 1023px) and (pointer: coarse) {
    .scroll-indicator {
      display: flex;
    }
  }

  .scroll-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--color-border);
    cursor: pointer;
    padding: 0;
    transition: all 0.2s ease;
  }

  .scroll-dot:hover {
    background: var(--color-text-muted);
  }

  .scroll-dot.active {
    background: var(--color-text);
    transform: scale(1.25);
  }

  /* Pulse animation on first load to draw attention */
  .scroll-indicator.pulse .scroll-dot {
    animation: dot-pulse 1.5s ease-in-out 2;
  }

  .scroll-indicator.pulse .scroll-dot:nth-child(2) {
    animation-delay: 0.15s;
  }

  @keyframes dot-pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.3); opacity: 1; }
  }

  .scroll-indicator.pulse .scroll-dot.active {
    animation: none;
    transform: scale(1.25);
    opacity: 1;
  }

  /* Examples */
  .examples-card {
    padding: var(--space-lg);
  }

  .examples-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-md);
  }

  .examples-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .example-btn {
    display: inline-block;
    padding: var(--space-xs) var(--space-md);
    font-size: 12px;
    color: var(--color-text-muted);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 999px;
    cursor: pointer;
    transition: var(--transition-fast);
  }

  .example-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--color-text);
    border-color: var(--color-border-hover);
  }

  /* Loading and error states */
  .panel-preview :global(.loading) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    color: var(--color-text-muted);
  }

  .panel-preview :global(.loading-dots) {
    font-size: 24px;
    animation: pulse 1.5s infinite;
  }

  .panel-preview :global(.error) {
    color: var(--color-accent);
    text-align: center;
    padding: var(--space-md);
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  /* Clickable images */
  .panel-preview :global(img) {
    cursor: pointer;
    transition: opacity var(--transition-fast);
  }

  .panel-preview :global(img:hover) {
    opacity: 0.9;
  }

  /* Lightbox */
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
  }

  .lightbox.active {
    display: flex;
  }

  .lightbox-close {
    position: absolute;
    top: var(--space-lg);
    right: var(--space-lg);
    background: none;
    border: none;
    color: var(--color-text);
    font-size: 32px;
    cursor: pointer;
    padding: var(--space-sm);
    line-height: 1;
    opacity: 0.7;
    transition: opacity var(--transition-fast);
  }

  .lightbox-close:hover {
    opacity: 1;
  }

  .lightbox img {
    max-width: 95vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: var(--radius-md);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }
</style>

<script>
  const API_BASE = 'https://ecdsa.pub/venom-preview/api/snap';

  const urlInput = document.getElementById('url-input') as HTMLInputElement;
  const botSelect = document.getElementById('bot-select') as HTMLSelectElement;
  const deviceSelect = document.getElementById('device-select') as HTMLSelectElement;
  const inlineMode = document.getElementById('inline-mode') as HTMLInputElement;
  const loadBtn = document.getElementById('load-btn') as HTMLButtonElement;
  const originalPanel = document.getElementById('original-panel') as HTMLDivElement;
  const poisonedPanel = document.getElementById('poisoned-panel') as HTMLDivElement;
  const originalStats = document.getElementById('original-stats') as HTMLDivElement;
  const poisonedStats = document.getElementById('poisoned-stats') as HTMLDivElement;
  const lightbox = document.getElementById('lightbox') as HTMLDivElement;
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
  const lightboxClose = document.querySelector('.lightbox-close') as HTMLButtonElement;
  const panelsContainer = document.getElementById('panels-container') as HTMLDivElement;
  const scrollIndicator = document.getElementById('scroll-indicator') as HTMLDivElement;
  const scrollDots = document.querySelectorAll('.scroll-dot') as NodeListOf<HTMLButtonElement>;

  let abortController: AbortController | null = null;
  let hasUserScrolled = false;

  // Update aspect ratio based on device selection
  function updateAspectRatio() {
    const mode = deviceSelect.value;
    // Desktop: 1280x720 = 16:9, Mobile: 390x844 ≈ 9:19
    const aspectRatio = mode === 'mobile' ? '390 / 844' : '16 / 9';
    document.documentElement.style.setProperty('--preview-aspect-ratio', aspectRatio);
  }

  function showLoading(panel: HTMLDivElement) {
    panel.innerHTML = `
      <div class="loading">
        <div class="loading-dots">●●●</div>
        <span style="font-size: 12px;">Generating screenshot...</span>
      </div>
    `;
  }

  function showError(panel: HTMLDivElement, message: string) {
    panel.innerHTML = `
      <div class="error">
        <div style="font-size: 20px; margin-bottom: 8px;">⚠</div>
        <span style="font-size: 12px;">${message}</span>
      </div>
    `;
  }

  function showImage(panel: HTMLDivElement, url: string) {
    const img = document.createElement('img');
    img.src = url;
    img.alt = 'Screenshot';
    img.loading = 'eager';
    img.addEventListener('click', () => openLightbox(url));
    panel.innerHTML = '';
    panel.appendChild(img);
  }

  function openLightbox(imgSrc: string) {
    lightboxImg.src = imgSrc;
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }

  async function loadPreview() {
    const url = urlInput.value.trim();
    if (!url) {
      alert('Please enter a URL');
      return;
    }

    // Abort any ongoing request
    if (abortController) {
      abortController.abort();
    }
    abortController = new AbortController();

    const bot = botSelect.value;
    const mode = deviceSelect.value;
    const inline = inlineMode.checked;

    // Update UI
    loadBtn.disabled = true;
    loadBtn.textContent = 'Loading...';
    showLoading(originalPanel);
    showLoading(poisonedPanel);
    originalStats.textContent = '';
    poisonedStats.textContent = '';

    try {
      // Build API URLs - url parameter must come last
      const originalUrl = `${API_BASE}?mode=${mode}&url=${encodeURIComponent(url)}`;
      const poisonedUrl = `${API_BASE}?bot=${bot}${inline ? '&inline=yes' : ''}&mode=${mode}&url=${encodeURIComponent(url)}`;

      // Fetch both screenshots in parallel
      const [originalResp, poisonedResp] = await Promise.all([
        fetch(originalUrl, { signal: abortController.signal }),
        fetch(poisonedUrl, { signal: abortController.signal })
      ]);

      if (!originalResp.ok || !poisonedResp.ok) {
        throw new Error('Failed to generate screenshots');
      }

      // Get image blobs and create object URLs
      const [originalBlob, poisonedBlob] = await Promise.all([
        originalResp.blob(),
        poisonedResp.blob()
      ]);

      showImage(originalPanel, URL.createObjectURL(originalBlob));
      showImage(poisonedPanel, URL.createObjectURL(poisonedBlob));

      // Update stats from headers
      originalStats.textContent = `Mode: ${mode}`;
      poisonedStats.textContent = `Bot: ${bot}${inline ? ' (inline)' : ''}`;

    } catch (err: any) {
      if (err.name === 'AbortError') return;
      console.error('Error:', err);
      showError(originalPanel, 'Failed to load');
      showError(poisonedPanel, err.message || 'Failed to load');
    } finally {
      loadBtn.disabled = false;
      loadBtn.textContent = 'Load Preview';
    }
  }

  // Lightbox event listeners
  lightboxClose.addEventListener('click', closeLightbox);
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });

  // Event listeners
  loadBtn.addEventListener('click', loadPreview);

  urlInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') loadPreview();
  });

  // Update aspect ratio when device changes
  deviceSelect.addEventListener('change', updateAspectRatio);

  // Example buttons
  document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      urlInput.value = (btn as HTMLElement).dataset.url || '';
      loadPreview();
    });
  });

  // Scroll indicator functionality
  function updateScrollIndicator() {
    const scrollLeft = panelsContainer.scrollLeft;
    const scrollWidth = panelsContainer.scrollWidth - panelsContainer.clientWidth;
    const progress = scrollWidth > 0 ? scrollLeft / scrollWidth : 0;

    // Determine which panel is more visible (0 = original, 1 = poisoned)
    const activeIndex = progress > 0.5 ? 1 : 0;

    scrollDots.forEach((dot, index) => {
      dot.classList.toggle('active', index === activeIndex);
    });
  }

  // Handle scroll on panels container
  panelsContainer.addEventListener('scroll', () => {
    updateScrollIndicator();

    // After first user scroll, remove pulse and eventually hide
    if (!hasUserScrolled) {
      hasUserScrolled = true;
      scrollIndicator.classList.remove('pulse');
    }
  }, { passive: true });

  // Click on dots to scroll to panel
  scrollDots.forEach((dot) => {
    dot.addEventListener('click', () => {
      const index = parseInt(dot.dataset.index || '0', 10);
      const panels = panelsContainer.querySelectorAll('.panel-card');
      if (panels[index]) {
        panels[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    });
  });

  // Add pulse animation on load (only on touch devices)
  if (window.matchMedia('(hover: none), (pointer: coarse)').matches) {
    scrollIndicator.classList.add('pulse');
  }

  // Initialize aspect ratio and auto-load on page load
  updateAspectRatio();
  loadPreview();
</script>
